<!DOCTYPE html>
<html>
<head>
    <title>pages</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <link href="styles/MyStSh.css" rel="stylesheet" type="text/css" />
    <link href="styles/jquery.mobile-1.4.5.min.css" rel="stylesheet" />
    <script src="scripts/jquery-1.12.4.min.js"></script>
    <script type="text/javascript">
        $(document).on('mobileinit', function () {
            $.mobile.defaultPageTransition = "slide";
        });
    </script>
    <script src="scripts/jquery.mobile-1.4.5.min.js"></script>
    <script type="text/javascript">
        function getadress() {
            var address = [];
            WebServiceURL = "ShopsWS.asmx";
            $.support.cors = true;
            $.ajax({
                url: WebServiceURL + "/GetShopsAdress",
                dataType: "json",
                async: false,
                type: "POST",
                data: "",
                contentType: "application/json; charset=utf-8",
                error: function (err) {
                    alert("errornir: " + JSON.stringify(err));
                },
                success: function (data) {
                    if (data["d"] != undefined) {
                        for (var i = 0; i < data["d"].length; i++)
                            address.push(data["d"][i])


                    }
                }
            });

            return address;
        }
        var getmin = function (values) {
            if(values.length==0)
                return -1;
            var min=values[0];
            for (var i = 1; i < values.length; i++)
                if (min < values[i])
                    min = values[i];
            return min;
        }


    </script>
</head>
<body>

    <!--the About page-->
    <div data-role="page" id="AboutPage" data-theme="a">
        <div data-role="header">
            <div data-role="navbar">
                <ul>
                    <li><a href="#AboutPage" class="ui-state-persist">About</a></li>
                    <li><a href="#OrderPage">Order</a></li>
                    <li><a href="#UserPage">User</a></li>
                    <li><a href="#MapPage">Map page</a></li>

                </ul>
            </div>
        </div>
        <div data-role="content">
            <p style="text-align:center">
                This is a Gluten Free Shop.<br />
                You can make an order and enjoy (or not)<br />
                our Products:)
            </p>
        </div>
        <div data-role="footer" data-position="fixed" data-theme="d">
            <h5>Gluten Free Shop &nbsp &copy; &nbsp Nir Chen</h5>
        </div>
    </div>

    <!--the Map page-->
    <div data-role="page" id="MapPage" data-theme="a">
        <div data-role="header">
            <div data-role="navbar">
                <ul>
                    <li><a href="#AboutPage" class="ui-state-persist">About</a></li>
                    <li><a href="#OrderPage">Order</a></li>
                    <li><a href="#UserPage">User</a></li>
                    <li><a href="#MapPage">Map page</a></li>

                </ul>
            </div>
        </div>
        <div data-role="content">
            <script src='https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyDMvuJFvCghEamrQNgQ68q3f6mYFNRpA1Q&libraries=geometry'></script><div style='overflow:hidden;height:440px;width:700px;'>
                <div id='gmap_canvas' style='height:440px;width:700px;'></div><div><small><a href="http://embedgooglemaps.com">									embed google maps							</a></small></div>
                <style>
                    #gmap_canvas img {
                        max-width: none !important;
                        background: none !important;
                    }
                </style>
            </div>
            <script type='text/javascript'>

                function init_map() {
                    geocoder = new google.maps.Geocoder();
                   
                    var myTrip = new Array();
                    var defaultLatLng = new google.maps.LatLng(34.0983425, -118.3267434);  // Default to Hollywood, CA when no geolocation support
                    if (navigator.geolocation) {
                        function success(pos) {
                            // Location found, show map with these coordinates
                            var myloc = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                            drawMap(myloc);
                            calcdist(myloc);
                        }
                        function fail(error) {
                            drawMap(defaultLatLng);  // Failed to find location, show default map
                            $('#BradAmount').text("Couldn't get location");
                        }
                        // Find the users current position.  Cache the location for 5 minutes, timeout after 6 seconds
                        navigator.geolocation.getCurrentPosition(success, fail, { maximumAge: 500000, enableHighAccuracy: true, timeout: 6000 });
                    } else {
                        drawMap(defaultLatLng);  // No geolocation support, show default map
                    }
                    function drawMap(latlng) {

                        alert(JSON.stringify(latlng));
                        var myOptions = {
                            zoom: 10,
                            center: latlng,
                            mapTypeId: google.maps.MapTypeId.ROADMAP
                        };
                        var map = new google.maps.Map(document.getElementById("gmap_canvas"), myOptions);
                        // Add an overlay to the map of current lat/lng
                        
                    }

                    function codeAddress(callback) {
                        var address = getadress();
                        var arr = [];
                        for (var i = 0; i < address.length;i++)
                        geocoder.geocode({ 'address': address[i] }, function (results, status) {
                            if (status == google.maps.GeocoderStatus.OK) {
                                lat = results[0].geometry.location.lat();
                                lng = results[0].geometry.location.lng();
                                arr.push({lat:lat,lng:lng})
                                callback(arr);
                            } else {
                                alert("Geocode was not successful for the following reason: " + status);
                            }
                        });

                        
                    }


                    function calcdist(myloc) {


                        codeAddress(function(arr){
                            adress=getadress();
                            if (arr.length == adress.length) {
                                var distances = [];
                                for (var i = 0; i < arr.length; i++) {
                                    distances.push(google.maps.geometry.spherical.computeDistanceBetween(myloc, new google.maps.LatLng(arr[i].lat, arr[i].lng)));
                                }
                                debugger;
                                var x = getmin(distances);

                                minimumindex = distances.indexOf(x);
                                if (minimumindex >= 0) {
                                  
                                    var myOptions = {
                                        zoom: 10,
                                        center: arr[minimumindex],
                                        mapTypeId: google.maps.MapTypeId.ROADMAP
                                    };
                                    var map = new google.maps.Map(document.getElementById("gmap_canvas"), myOptions);
                                    var marker = new google.maps.Marker({
                                        position: arr[minimumindex],
                                        map: map,
                                        title: "Greetings!"
                                    });
                                    infowindow = new google.maps.InfoWindow({ content: '</br><strong>location</strong></br>' + adress[minimumindex] + '<br>' });
                                    google.maps.event.addListener(marker, 'click', function () { infowindow.open(map, marker); });
                                    infowindow.open(map, marker);
                                }
                            }
                        });



                        
                      
                       
                    }

                    
                   
                }
                google.maps.event.addDomListener(window, 'load', init_map());
            </script>

        </div>
        
            <div data-role="footer" data-position="fixed" data-theme="d">
                <h5>Gluten Free Shop &nbsp &copy; &nbsp Nir Chen</h5>
            </div>
        </div>


</body>
</html>
